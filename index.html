<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spiritual Gifts Assessment</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-green-50 min-h-screen p-4">

    <div class="max-w-4xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden mt-8">
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-8 text-center text-white">
            <h1 class="text-4xl md:text-5xl font-extrabold">Spiritual Gifts Assessment</h1>
            <p class="mt-4 text-indigo-100" id="user-id-display">Starting offline mode...</p>
        </div>

        <div class="p-8 space-y-12">
            <div id="assessment-view">
                <div id="question-area" class="bg-indigo-50 rounded-2xl p-10 text-center border-2 border-indigo-200">
                    <h3 class="text-3xl font-bold text-indigo-800">Question 1 / 200</h3>
                    <p class="text-lg mt-3 text-gray-600">0 = Not at all • 5 = Very Strongly</p>
                </div>

                <form id="score-form" class="mt-10 flex flex-col md:flex-row gap-6 items-center justify-center">
                    <input type="number" id="score-input" min="0" max="5" value="0"
                           class="w-full md:w-48 p-8 text-6xl font-bold text-center rounded-2xl border-4 border-indigo-300 focus:border-indigo-600 outline-none"
                           oninput="this.value = Math.max(0, Math.min(5, parseInt(this.value)||0))">
                    <button type="submit"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-2xl py-8 px-12 rounded-2xl shadow-xl transform hover:scale-105 transition">
                        Submit → (Enter)
                    </button>
                </form>

                <div class="mt-10">
                    <p id="progress-text" class="text-right text-gray-600 font-medium text-lg">Progress: 0/200 (0%)</p>
                    <div class="w-full bg-gray-200 rounded-full h-8 mt-2 overflow-hidden">
                        <div id="progress-bar" class="bg-gradient-to-r from-indigo-500 to-purple-500 h-full transition-all duration-500" style="width:0%"></div>
                    </div>
                </div>
            </div>

            <div id="results-view" class="hidden space-y-10">
                <h2 class="text-5xl font-extrabold text-center text-green-600">Assessment Complete!</h2>
                <div id="top-gift-display" class="bg-gradient-to-br from-green-50 to-emerald-50 p-10 rounded-3xl border-4 border-green-400"></div>
                <div class="bg-white p-8 rounded-3xl shadow-xl">
                    <h3 class="text-3xl font-bold mb-6 text-center">Your Top 4 Gifts</h3>
                    <div id="top-four-list" class="space-y-4"></div>
                </div>
                <button onclick="window.app.resetAssessment()"
                        class="w-full bg-red-600 hover:bg-red-700 text-white font-bold text-2xl py-6 rounded-2xl shadow-xl transition transform hover:scale-105">
                    Start New Assessment
                </button>
            </div>

            <div id="status-message" class="fixed bottom-6 left-1/2 -translate-x-1/2 max-w-lg w-full p-4 rounded-lg text-center font-medium hidden"></div>
        </div>
    </div>

    <!-- Your config.js is perfect — leave it exactly as you have it -->
    <script src="./config.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const CATEGORIES = ["Apostleship","Prophecy","Evangelism","Shepherding","Teaching","Serving","Exhortation","Giving","Giving Aid","Compassion","Healing","Working Miracles","Tongues","Interpretation of Tongues","Wisdom","Knowledge","Faith","Discernment","Helps","Administration"];
        const QUESTION_COUNT = 200;

        const GIFT_DETAILS = {
            "Apostleship": { description: "You have a special ability to develop new ministries, churches, or missions in areas where the Gospel has not yet been established. You are a pioneer and an innovator.", prevalence: "1%", bibleCharacter: "Paul", bibleVerse: "2 Corinthians 11:28", bibleVerse2: "Ephesians 4:11" },
            "Prophecy": { description: "You are able to proclaim God's truth with clarity and apply it powerfully to a present situation, often speaking with great conviction.", prevalence: "3%", bibleCharacter: "Agabus", bibleVerse: "Acts 11:28", bibleVerse2: "1 Corinthians 14:3" },
            "Evangelism": { description: "You have a deep desire and effectiveness in sharing the Gospel with non-believers, leading them to faith in Jesus Christ.", prevalence: "12%", bibleCharacter: "Philip", bibleVerse: "Acts 8:5-6", bibleVerse2: "Ephesians 4:11" },
            "Shepherding": { description: "You have the capacity to care for the spiritual welfare of a group of believers, guiding, protecting, and nurturing them.", prevalence: "10%", bibleCharacter: "Peter", bibleVerse: "1 Peter 5:2", bibleVerse2: "Ephesians 4:11" },
            "Teaching": { description: "You are gifted at clearly explaining, systematizing, and applying God's Word so others grow in faith.", prevalence: "15%", bibleCharacter: "Apollos", bibleVerse: "Acts 18:24-28", bibleVerse2: "Romans 12:7" },
            "Serving": { description: "You find joy and fulfillment in meeting practical needs and alleviating burdens for others, often behind the scenes.", prevalence: "25%", bibleCharacter: "Phoebe", bibleVerse: "Romans 16:1-2", bibleVerse2: "1 Peter 4:11" },
            "Exhortation": { description: "You have the ability to encourage, motivate, and counsel others toward action and greater spiritual vitality.", prevalence: "18%", bibleCharacter: "Barnabas", bibleVerse: "Acts 4:36", bibleVerse2: "Romans 12:8" },
            "Giving": { description: "You possess the ability to contribute material resources to the Lord's work with liberality and cheerfulness.", prevalence: "8%", bibleCharacter: "The Macedonian Churches", bibleVerse: "2 Corinthians 8:2-3", bibleVerse2: "Romans 12:8" },
            "Giving Aid": { description: "Your gift is the capacity to wisely manage and steward resources, projects, or people to achieve God's goals.", prevalence: "10%", bibleCharacter: "Dorcas (Tabitha)", bibleVerse: "Acts 9:36", bibleVerse2: "1 Corinthians 12:28" },
            "Compassion": { description:: "You are able to feel genuine empathy and concern for suffering people and translate that compassion into effective action.", prevalence: "22%", bibleCharacter: "The Good Samaritan", bibleVerse: "Luke 10:33-34", bibleVerse2: "Romans 12:8" },
            "Healing": { description: "You are used by God to restore health and wholeness, physically or emotionally.", prevalence: "2%", bibleCharacter: "Paul", bibleVerse: "Acts 14:9-10", bibleVerse2: "1 Corinthians 12:9" },
            "Working Miracles": { description: "You have the capacity to perform mighty acts of God that alter the normal course of nature.", prevalence: "1%", bibleCharacter: "Elijah", bibleVerse: "1 Kings 17:16", bibleVerse2: "1 Corinthians 12:10" },
            "Tongues": { description: "You have the ability to speak a language you have never learned.", prevalence: "4%", bibleCharacter: "The Disciples at Pentecost", bibleVerse: "Acts 2:4", bibleVerse2: "1 Corinthians 14:4" },
            "Interpretation of Tongues": { description: "You are able to translate the message of one speaking in tongues.", prevalence: "2%", bibleCharacter: "Paul", bibleVerse: "1 Corinthians 14:13", bibleVerse2: "1 Corinthians 14:27" },
            "Wisdom": { description: "You are granted exceptional insight into how to apply spiritual truth.", prevalence: "6%", bibleCharacter: "Solomon", bibleVerse: "1 Kings 3:28", bibleVerse2: "1 Corinthians 12:8" },
            "Knowledge": { description: "You are given the capacity to discover, analyze, and systematize truth.", prevalence: "7%", bibleCharacter: "Luke", bibleVerse: "Luke 1:3-4", bibleVerse2: "1 Corinthians 12:8" },
            "Faith": { description: "You possess extraordinary confidence in God's promises.", prevalence: "5%", bibleCharacter: "Abraham", bibleVerse: "Romans 4:20-21", bibleVerse2: "1 Corinthians 12:9" },
            "Discernment": { description: "You have the power to clearly distinguish between truth and error.", prevalence: "11%", bibleCharacter: "Paul", bibleVerse: "Acts 16:18", bibleVerse2: "1 Corinthians 12:10" },
            "Helps": { description: "Your gift is the ability to assist others in their ministry.", prevalence: "20%", bibleCharacter: "Timothy", bibleVerse: "Philippians 2:20-22", bibleVerse2: "Romans 16:3" },
            "Administration": { description: "You are skilled at planning, organizing, and directing groups.", prevalence: "13%", bibleCharacter: "Nehemiah", bibleVerse: "Nehemiah 2:17-18", bibleVerse2: "1 Corinthians 12:28" }
        };

        let db = null, auth = null, userId = null, isFirebaseReady = false;
        let currentAnswers = new Array(QUESTION_COUNT + 1).fill(null);
        let currentQuestion = 1;

        const el = {
            questionArea: document.getElementById('question-area'),
            scoreInput: document.getElementById('score-input'),
            progressText: document.getElementById('progress-text'),
            progressBar: document.getElementById('progress-bar'),
            assessmentView: document.getElementById('assessment-view'),
            resultsView: document.getElementById('results-view'),
            topGiftDisplay: document.getElementById('top-gift-display'),
            topFourList: document.getElementById('top-four-list'),
            statusMessage: document.getElementById('status-message'),
            userIdDisplay: document.getElementById('user-id-display')
        };

        // Your config.js is PERFECT — this handles it correctly
        const appId = window.__app_id || 'local';
        let firebaseConfig = {};
        if (typeof window.__firebase_config === 'string' && window.__firebase_config.trim() !== '' && window.__firebase_config !== '{}') {
            try { firebaseConfig = JSON.parse(window.__firebase_config); } catch(e) {}
        }

        const showStatus = (msg, error = false) => {
            el.statusMessage.textContent = msg;
            el.statusMessage.className = `p-4 rounded-lg font-medium ${error ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            el.statusMessage.style.display = 'block';
            setTimeout(() => el.statusMessage.style.display = 'none', 4000);
        };

        const saveProgress = async (data) => {
            if (!isFirebaseReady || !userId) return;
            try {
                await setDoc(doc(db, "artifacts", appId, "users", userId, "assessment_progress", "data"), {
                    answers: JSON.stringify(data),
                    lastUpdated: new Date()
                });
            } catch (e) {}
        };

        const loadProgress = async () => {
            if (!isFirebaseReady || !userId) return null;
            try {
                const snap = await getDoc(doc(db, "artifacts", appId, "users", userId, "assessment_progress", "data"));
                if (snap.exists() && snap.data().answers) {
                    showStatus("Progress loaded from cloud!");
                    return JSON.parse(snap.data().answers);
                }
            } catch (e) {}
            return null;
        };

        const updateUI = () => {
            const answered = currentAnswers.filter(a => a !== null).length - 1;
            if (answered === QUESTION_COUNT) { renderResults(); return; }

            while (currentQuestion <= QUESTION_COUNT && currentAnswers[currentQuestion] !== null) currentQuestion++;
            if (currentQuestion > QUESTION_COUNT) { renderResults(); return; }

            el.questionArea.innerHTML = `<h3 class="text-3xl font-bold text-indigo-800">Question ${currentQuestion} / 200</h3>
                <p class="text-lg mt-3 text-gray-600">0 = Not at all • 5 = Very Strongly</p>`;
            el.scoreInput.value = currentAnswers[currentQuestion] || 0;
            el.scoreInput.focus();
            el.scoreInput.select();

            const pct = (answered / 200) * 100;
            el.progressText.textContent = `Progress: ${answered}/200 (${pct.toFixed(0)}%)`;
            el.progressBar.style.width = `${pct}%`;
        };

        document.getElementById('score-form').addEventListener('submit', e => {
            e.preventDefault();
            const score = parseInt(el.scoreInput.value, 10);
            if (isNaN(score) || score < 0 || score > 5) {
                showStatus("Please enter 0–5", true);
                return;
            }
            currentAnswers[currentQuestion] = score;
            saveProgress(currentAnswers);
            currentQuestion++;
            updateUI();
        });

        const calculateResults = () => {
            const sums = new Array(20).fill(0);
            for (let q = 1; q <= 200; q++) {
                if (currentAnswers[q] !== null) sums[(q-1)%20] += currentAnswers[q];
            }
            return CATEGORIES.map((g,i) => ({gift: g, score: sums[i]})).sort((a,b) => b.score - a.score);
        };

        const renderResults = () => {
            const sorted = calculateResults();
            const top = sorted[0];
            const d = GIFT_DETAILS[top.gift];

            el.assessmentView.classList.add('hidden');
            el.resultsView.classList.remove('hidden');

            el.topGiftDisplay.innerHTML = `
                <div class="text-center">
                    <h4 class="text-xl font-semibold text-gray-700">Your Primary Gift</h4>
                    <h1 class="text-6xl font-extrabold text-green-600 my-4">${top.gift}</h1>
                    <p class="text-3xl font-bold mb-8">Score: ${top.score}/100</p>
                </div>
                <div class="bg-green-50 p-6 rounded-2xl border-2 border-green-300 mb-8">
                    <p class="text-lg leading-relaxed">${d.description}</p>
                    <p class="text-sm font-bold text-green-700 mt-4">Only ~${d.prevalence} of believers have this as their top gift.</p>
                </div>
                <div class="bg-blue-50 p-6 rounded-2xl border-2 border-blue-300">
                    <h3 class="text-2xl font-bold text-blue-800 mb-4">Biblical Example: ${d.bibleCharacter}</h3>
                    <p class="italic text-gray-700">"${d.bibleVerse}"</p>
                    <p class="italic text-gray-700 text-sm mt-2">"${d.bibleVerse2}"</p>
                </div>
            `;

            el.topFourList.innerHTML = sorted.slice(0,4).map((item,i) => {
                const dd = GIFT_DETAILS[item.gift];
                const style = i === 0 ? 'bg-yellow-100 border-yellow-400' : 'bg-gray-50 border-gray-300';
                return `<div class="p-6 rounded-xl border-2 ${style} flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <span class="text-4xl font-bold text-indigo-600">#${i+1}</span>
                        <div>
                            <div class="text-xl font-bold">${item.gift}</div>
                            <div class="text-sm text-gray-600">~${dd.prevalence} prevalence</div>
                        </div>
                    </div>
                    <span class="text-3xl font-bold text-green-600">${item.score}</span>
                </div>`;
            }).join('');
        };

        window.app = {
            resetAssessment: () => {
                if (confirm("Are you sure you want to clear all progress?")) {
                    currentAnswers = new Array(201).fill(null);
                    currentQuestion = 1;
                    if (isFirebaseReady) saveProgress(currentAnswers);
                    showStatus("Started fresh!");
                    updateUI();
                }
            }
        };

        // This works perfectly with your current config.js
        const start = async () => {
            el.userIdDisplay.textContent = "Offline mode • Local only";

            // Try to init Firebase only if config is real
            if (firebaseConfig && firebaseConfig.projectId) {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    await signInAnonymously(auth);
                    onAuthStateChanged(auth, user => {
                        if (user) {
                            userId = user.uid;
                            isFirebaseReady = true;
                            el.userIdDisplay.textContent = `Connected • Cloud save enabled`;
                            window.app.loadProgressAndStart = async () => {
                                const saved = await loadProgress();
                                if (saved) currentAnswers = saved;
                                updateUI();
                            };
                            window.app.loadProgressAndStart();
                        }
                    });
                    return;
                } catch (e) {
                    console.warn("Firebase failed, running offline");
                }
            }

            // Always start instantly (your config.js intentionally has {} so this runs)
            updateUI();
        };

        start();
    </script>
</body>
</html>
