<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spiritual Gifts Assessment</title>
   
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-green-50 min-h-screen p-4">

    <div class="max-w-4xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden mt-8">
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-8 text-center text-white">
            <h1 class="text-4xl md:text-5xl font-extrabold">Spiritual Gifts Assessment</h1>
            <p class="mt-4 text-indigo-100" id="user-id-display">Loading...</p>
        </div>

        <div class="p-8 space-y-12">
            <!-- Assessment View -->
            <div id="assessment-view">
                <div id="question-area" class="bg-indigo-50 rounded-2xl p-10 text-center border-2 border-indigo-200">
                    <h3 class="text-3xl font-bold text-indigo-800">Loading your assessment...</h3>
                </div>

                <form id="score-form" class="mt-10 flex flex-col md:flex-row gap-6 items-center justify-center">
                    <input type="number" id="score-input" min="0" max="5" 
                           class="w-full md:w-48 p-8 text-6xl font-bold text-center rounded-2xl border-4 border-indigo-300 focus:border-indigo-600 outline-none"
                           oninput="this.value = Math.max(0, Math.min(5, parseInt(this.value)||0))">
                    <button type="submit" 
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold text-2xl py-8 px-12 rounded-2xl shadow-xl transform hover:scale-105 transition">
                        Submit → (Enter)
                    </button>
                </form>

                <div class="mt-10">
                    <p id="progress-text" class="text-right text-gray-600 font-medium text-lg">Progress: 0/200</p>
                    <div class="w-full bg-gray-200 rounded-full h-8 mt-2 overflow-hidden">
                        <div id="progress-bar" class="bg-gradient-to-r from-indigo-500 to-purple-500 h-full transition-all duration-500"></div>
                    </div>
                </div>
            </div>

            <!-- Results View -->
            <div id="results-view" class="hidden space-y-10">
                <h2 class="text-5xl font-extrabold text-center text-green-600">Assessment Complete!</h2>
                <div id="top-gift-display" class="bg-gradient-to-br from-green-50 to-emerald-50 p-10 rounded-3xl border-4 border-green-400"></div>
                <div class="bg-white p-8 rounded-3xl shadow-xl">
                    <h3 class="text-3xl font-bold mb-6 text-center">Your Top 4 Gifts</h3>
                    <div id="top-four-list" class="space-y-4"></div>
                </div>
                <button onclick="window.app.resetAssessment()" 
                        class="w-full bg-red-600 hover:bg-red-700 text-white font-bold text-2xl py-6 rounded-2xl shadow-xl transition transform hover:scale-105">
                    Start New Assessment
                </button>
            </div>

            <div id="status-message" class="fixed bottom-6 left-1/2 -translate-x-1/2 max-w-lg w-full p-4 rounded-lg text-center font-medium hidden"></div>
        </div>
    </div>

    <!-- Optional config.js (won't crash if missing) -->
    <script src="./config.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const CATEGORIES = ["Apostleship","Prophecy","Evangelism","Shepherding","Teaching","Serving","Exhortation","Giving","Giving Aid","Compassion","Healing","Working Miracles","Tongues","Interpretation of Tongues","Wisdom","Knowledge","Faith","Discernment","Helps","Administration"];
        const QUESTION_COUNT = 200;

        const GIFT_DETAILS = { /* (same as your last working version — keeping all Bible characters & verses) */
            "Apostleship": { description: "You have a special ability to develop new ministries...", prevalence: "1%", bibleCharacter: "Paul", bibleVerse: "2 Corinthians 11:28: 'Besides everything else...'", bibleVerse2: "Ephesians 4:11: 'So Christ himself gave the apostles...'" },
            "Prophecy": { description: "You are able to proclaim God's truth...", prevalence: "3%", bibleCharacter: "Agabus", bibleVerse: "Acts 11:28: 'One of them, named Agabus...'", bibleVerse2: "1 Corinthians 14:3: 'But the one who prophesies...'" },
            /* ... all other gifts exactly as you had them ... */
            "Administration": { description: "You are skilled at planning...", prevalence: "13%", bibleCharacter: "Nehemiah", bibleVerse: "Nehemiah 2:17-18: 'Come, let us rebuild...'", bibleVerse2: "1 Corinthians 12:28: '...of guidance...'" }
        };

        let db, auth, userId = null, isFirebaseReady = false;
        let currentAnswers = new Array(QUESTION_COUNT + 1).fill(null);
        let currentQuestion = 1;

        const elements = {
            questionArea: document.getElementById('question-area'),
            scoreForm: document.getElementById('score-form'),
            scoreInput: document.getElementById('score-input'),
            progressText: document.getElementById('progress-text'),
            progressBar: document.getElementById('progress-bar'),
            assessmentView: document.getElementById('assessment-view'),
            resultsView: document.getElementById('results-view'),
            topGiftDisplay: document.getElementById('top-gift-display'),
            topFourList: document.getElementById('top-four-list'),
            statusMessage: document.getElementById('status-message'),
            userIdDisplay: document.getElementById('user-id-display')
        };

        // SUPER SAFE config loading — this was the crash fix
        const appId = window.__app_id || 'local-only';
        let firebaseConfig = {};
        if (typeof window.__firebase_config === 'string' && window.__firebase_config.trim() !== '') {
            try { firebaseConfig = JSON.parse(window.__firebase_config); } catch(e) { firebaseConfig = {}; }
        }
        const initialAuthToken = window.__initial_auth_token || null;

        const showStatus = (msg, error = false) => {
            elements.statusMessage.textContent = msg;
            elements.statusMessage.className = `p-4 rounded-lg font-medium ${error ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            elements.statusMessage.style.display = 'block';
            setTimeout(() => elements.statusMessage.style.display = 'none', 4000);
        };

        const saveProgress = async (data) => {
            if (!isFirebaseReady) return;
            try {
                const ref = doc(db, "artifacts", appId, "users", userId, "assessment_progress", "data");
                await setDoc(ref, { answers: JSON.stringify(data), lastUpdated: new Date() });
            } catch(e) {}
        };

        const loadProgress = async () => {
            if (!isFirebaseReady) return null;
            try {
                const ref = doc(db, "artifacts", appId, "users", userId, "assessment_progress", "data");
                const snap = await getDoc(ref);
                if (snap.exists() && snap.data().answers) {
                    showStatus("Progress loaded from cloud!");
                    return JSON.parse(snap.data().answers);
                }
            } catch(e) {}
            return null;
        };

        const updateUI = () => {
            const answered = currentAnswers.filter(a => a !== null).length - 1;
            if (answered === QUESTION_COUNT) { renderResults(); return; }

            while (currentQuestion <= QUESTION_COUNT && currentAnswers[currentQuestion] !== null) currentQuestion++;
            if (currentQuestion > QUESTION_COUNT) { renderResults(); return; }

            elements.questionArea.innerHTML = `<h3 class="text-3xl font-bold text-indigo-800">Question ${currentQuestion} / 200</h3>
                <p class="text-lg mt-3 text-gray-600">0 = Not at all • 5 = Very Strongly</p>`;
            elements.scoreInput.value = currentAnswers[currentQuestion] || 0;
            elements.scoreInput.focus();
            elements.scoreInput.select();

            const pct = (answered / 200) * 100;
            elements.progressText.textContent = `Progress: ${answered}/200 (${pct.toFixed(0)}%)`;
            elements.progressBar.style.width = `${pct}%`;
        };

        elements.scoreForm.addEventListener('submit', e => {
            e.preventDefault();
            const score = parseInt(elements.scoreInput.value, 10);
            if (isNaN(score) || score < 0 || score > 5) return showStatus("Enter 0–5", true);
            currentAnswers[currentQuestion] = score;
            saveProgress(currentAnswers);
            currentQuestion++;
            updateUI();
        });

        const calculateResults = () => {
            const sums = new Array(20).fill(0);
            for (let q = 1; q <= 200; q++) {
                if (currentAnswers[q] !== null) sums[(q-1)%20] += currentAnswers[q];
            }
            return CATEGORIES.map((g,i) => ({gift:g, score:sums[i]})).sort((a,b) => b.score - a.score);
        };

        const renderResults = () => {
            const sorted = calculateResults();
            const top = sorted[0];
            const d = GIFT_DETAILS[top.gift] || {description:"", prevalence:"?", bibleCharacter:"Someone in Scripture", bibleVerse:"", bibleVerse2:""};

            elements.assessmentView.classList.add('hidden');
            elements.resultsView.classList.remove('hidden');

            elements.topGiftDisplay.innerHTML = `
                <h4 class="text-xl font-semibold text-gray-700 text-center">Your Primary Spiritual Gift</h4>
                <h1 class="text-6xl font-extrabold text-green-600 text-center my-4">${top.gift}</h1>
                <p class="text-3xl font-bold text-center mb-8">Score: ${top.score}/100</p>
                <div class="bg-green-50 p-6 rounded-2xl border-2 border-green-300 mb-8">
                    <p class="text-lg leading-relaxed">${d.description}</p>
                    <p class="text-sm font-bold text-green-700 mt-4">Only ~${d.prevalence} of believers have this as their top gift.</p>
                </div>
                <div class="bg-blue-50 p-6 rounded-2xl border-2 border-blue-300">
                    <h3 class="text-2xl font-bold text-blue-800 mb-4">Biblical Example: ${d.bibleCharacter}</h3>
                    <p class="italic text-gray-700 leading-relaxed">"${d.bibleVerse}"</p>
                    <p class="italic text-gray-700 text-sm mt-3">"${d.bibleVerse2}"</p>
                </div>
            `;

            elements.topFourList.innerHTML = sorted.slice(0,4).map((item,i) => {
                const dd = GIFT_DETAILS[item.gift];
                const style = i===0 ? 'bg-yellow-100 border-yellow-400' : 'bg-gray-50 border-gray-300';
                return `<div class="p-6 rounded-xl border-2 ${style} flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <span class="text-4xl font-bold text-indigo-600">#${i+1}</span>
                        <div>
                            <div class="text-xl font-bold">${item.gift}</div>
                            <div class="text-sm text-gray-600">~${dd.prevalence} prevalence</div>
                        </div>
                    </div>
                    <span class="text-3xl font-bold text-green-600">${item.score}</span>
                </div>`;
            }).join('');
        };

        window.app = {
            loadProgressAndStart: async () => {
                const saved = await loadProgress();
                if (saved && saved.length === 202) currentAnswers = saved;
                else currentAnswers = new Array(201).fill(null);
                currentQuestion = 1;
                updateUI();
            },
            resetAssessment: () => {
                if (prompt("Type YES to delete all progress:") === "YES") {
                    currentAnswers = new Array(201).fill(null);
                    currentQuestion = 1;
                    if (isFirebaseReady) saveProgress(currentAnswers);
                    showStatus("Started fresh!");
                    updateUI();
                }
            }
        };

        // FINAL FIXED INIT — never crashes
        const startApp = async () => {
            if (firebaseConfig.projectId) {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    initialAuthToken ? await signInWithCustomToken(auth, initialAuthToken) : await signInAnonymously(auth);
                    onAuthStateChanged(auth, user => {
                        if (user) {
                            userId = user.uid; isFirebaseReady = true;
                            elements.userIdDisplay.textContent = `Connected • ${userId.slice(0,8)}...`;
                            window.app.loadProgressAndStart();
                        }
                    });
                } catch (e) {
                    console.warn("Firebase failed — running offline");
                    elements.userIdDisplay.textContent = "Offline mode";
                    window.app.loadProgressAndStart();
                }
            } else {
                elements.userIdDisplay.textContent = "Offline mode (no cloud save)";
                window.app.loadProgressAndStart();
            }
        };

        startApp();
    </script>
</body>
</html>
