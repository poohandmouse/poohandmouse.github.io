<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Discover Your Spiritual Gift</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body class="bg-gradient-to-b from-blue-50 to-indigo-100 min-h-screen font-sans">
<div class="max-w-2xl mx-auto p-6">
    <div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
        <div class="bg-gradient-to-r from-indigo-600 to-blue-700 p-8 text-white text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-2">Discover Your Spiritual Gift</h1>
            <p class="text-indigo-100 text-lg">28 Biblical Gifts • 140 Questions</p>
            <p class="text-sm mt-4 opacity-90" id="user-id-display">Offline mode • Local only</p>
        </div>

        <!-- Assessment View -->
        <div id="assessment-view" class="p-8 space-y-10">
            <div class="text-center">
                <div class="text-6xl font-bold text-indigo-600 mb-4" id="current-question-num">1</div>
                <p class="text-gray-600 text-lg">of 140 questions</p>
            </div>
            <div id="question-text" class="bg-blue-50 rounded-2xl p-8 text-xl text-gray-800 leading-relaxed border-2 border-blue-200">
                Loading your first question...
            </div>
            <form id="score-form" class="space-y-8">
                <div class="flex justify-center">
                    <input type="number" id="score-input" min="0" max="5"
                           class="w-56 h-56 text-9xl font-extrabold text-center rounded-3xl border-4 border-indigo-400 focus:border-indigo-600 outline-none shadow-2xl bg-white md:w-72 md:h-72 md:text-[12rem]"
                           placeholder="?" autocomplete="off">
                </div>
                <div class="grid grid-cols-2 gap-4 text-sm text-gray-600">
                    <div class="text-left">0 = Never</div>
                    <div class="text-right">5 = Always</div>
                    <div class="text-left col-span-2 text-center text-gray-500">1 = Rarely • 2 = Sometimes • 3 = Often • 4 = Very Often</div>
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-700 hover:to-blue-700 text-white font-bold text-2xl py-6 rounded-2xl shadow-xl transition transform hover:scale-105">
                    Next Question
                </button>
            </form>
            <div class="mt-8">
                <div class="text-right text-gray-600 font-medium mb-2" id="progress-text">0%</div>
                <div class="w-full bg-gray-300 rounded-full h-6 overflow-hidden shadow-inner">
                    <div id="progress-bar" class="bg-gradient-to-r from-indigo-500 to-blue-500 h-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Results View -->
        <div id="results-view" class="hidden p-8 space-y-12">
            <div class="text-center">
                <h2 class="text-5xl font-bold text-green-600 mb-4">Congratulations!</h2>
                <p class="text-2xl text-gray-700">Here are your top spiritual gifts</p>
            </div>
            <div id="top-gift-display" class="bg-gradient-to-br from-green-50 to-emerald-100 rounded-3xl p-10 border-4 border-green-400 shadow-2xl"></div>
            <div class="space-y-8" id="top-four-list"></div>
            <button onclick="window.app.resetAssessment()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold text-xl py-6 rounded-2xl shadow-xl transition">
                Take Assessment Again
            </button>
            <p class="text-center text-gray-600 text-sm mt-10">
                Based on Romans 12, 1 Corinthians 12, Ephesians 4 & 1 Peter 4
            </p>
        </div>
    </div>
</div>

<script src="./config.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ================================
    // 28 GIFTS — FINAL LIST
    // ================================
    const GIFTS = [
        "Administration","Apostleship","Craftsmanship","Creative Communication","Discernment of Spirits",
        "Encouragement","Evangelism","Faith","Giving","Healing","Helps/Service","Hospitality","Intercession",
        "Interpretation of Tongues","Knowledge","Leadership","Mercy","Miracles","Music/Worship","Pastoral Care",
        "Prophecy","Service","Shepherding","Teaching","Tongues","Wisdom","Witnessing","Writing"
    ];

    const TOTAL_QUESTIONS = 140; // 28 gifts × 5 questions each

    // 140 carefully crafted questions (5 per gift) — Bryant-style
    const BASE_QUESTIONS = [
        // 1. Administration
        "I excel at organizing people and resources for ministry","I naturally create systems so things run smoothly","People trust me to manage projects and details","I bring order out of chaos in church settings","Deadlines and planning energize me",
        // 2. Apostleship
        "I feel called to start new churches or ministries","I thrive in unreached or pioneering environments","I adapt quickly to new cultures","God has used me to birth new works","I’m drawn to places where the gospel isn’t yet known",
        // 3. Craftsmanship
        "I love building or creating things that glorify God","My artistic/technical skills bless the church","I enjoy designing banners, fixing facilities, or creating visuals","People comment on the excellence of what I make","I sense God’s pleasure when I create beautifully",
        // 4. Creative Communication
        "I express God’s truth through art, writing, drama, or media","I can make deep theology clear and beautiful","My creative work moves people emotionally and spiritually","God speaks through my writing or designs","Others grow closer to Jesus because of my creativity",
        // 5. Discernment of Spirits
        "I quickly sense when something is not from God","I can distinguish truth from error in teaching","I feel physical reactions around demonic influence","God has used me to expose deception","People ask me to test spiritual experiences",
        // 6. Encouragement (Exhortation)
        "People say my words build them up","I love calling out God-given potential in others","I comfort the discouraged effectively","My presence brings hope in hard times","I write notes or texts that strengthen faith",
        // 7. Evangelism
        "Unbelievers open up to me easily","I regularly lead people to Christ","Sharing the gospel feels natural and joyful","Strangers trust me with their spiritual questions","I feel deep burden for the lost",
        // 8. Faith
        "I pray expecting God-sized answers","I trust God in impossible situations","Others are strengthened by my faith","I step out when God speaks, even if it looks risky","God has answered dramatic prayers dramatically through me",
        // 9. Giving
        "I give generously and cheerfully","I look for needs I can meet financially or practically","I live simply so I can give more","God provides supernaturally so I can bless others","I often give anonymously",
        // 10. Healing
        "People experience healing when I pray","I feel compassion surge when praying for the sick","I regularly pray for physical, emotional, or spiritual healing","God has used me as a channel of healing","I believe God heals today",
        // 11. Helps/Service
        "I love practical, behind-the-scenes work","I notice needs others overlook","Serving without recognition brings me joy","I free leaders by handling details","I serve gladly in unseen roles",
        // 12. Hospitality
        "My home is always open to others","I make guests feel truly welcome","Hosting events or people energizes me","People relax and open up in my space","I love feeding and housing God’s people",
        // 13. Intercession
        "I pray for hours with passion","I wake up burdened to pray","Prayer breakthroughs follow my intercession","I carry prayer lists and see answers","I sense spiritual warfare in prayer",
        // 14. Interpretation of Tongues
        "I often understand the meaning of tongues messages","God gives me interpretation in meetings","The church is edified when I interpret","I desire this gift for the Body’s benefit","I have interpreted accurately before",
        // 15. Knowledge (Word of)
        "God reveals facts I couldn’t know naturally","I receive supernatural insight in prayer","God shows me hidden things about people/situations","My knowledge gifts help solve problems","People are amazed at what God reveals",
        // 16. Leadership
        "People naturally follow my direction","I cast vision others get excited about","I guide groups toward God’s purposes","I delegate well and empower others","Teams accomplish more under my leadership",
        // 17. Mercy
        "My heart breaks for the suffering","I visit hospitals, prisons, nursing homes","I forgive easily and completely","I weep with those who weep","People feel Jesus’ love through me",
        // 18. Miracles
        "God has performed undeniable miracles through my prayers","Nature or circumstances shift when I pray","I expect supernatural intervention","People are delivered or healed when I pray with authority","I’ve seen creative miracles",
        // 19. Music/Worship
        "Leading worship brings God’s presence strongly","My music moves people to repentance or joy","I write songs or play for God’s glory","The atmosphere shifts when I lead worship","Worship is my primary calling",
        // 20. Pastoral Care
        "I nurture spiritual growth in individuals","People trust me with deep wounds","I disciple one-on-one or small groups","I restore those who’ve fallen away","I carry people’s burdens to Jesus",
        // 21. Prophecy
        "God speaks timely words through me","My words bring conviction or encouragement","I sense what God is saying now to the church","Prophecy through me builds up others","I speak God’s heart accurately",
        // 22. Service (kept for compatibility with Helps)
        "I serve joyfully wherever needed","Practical service is my love language","I free others for ministry by serving","Serving is worship to me","I find joy in unseen tasks",
        // 23. Shepherding
        "I protect and guide God’s people","I know when sheep are hurting","I restore straying believers","Small group ministry is my heartbeat","I have a pastor’s heart",
        // 24. Teaching
        "I make Scripture clear and life-changing","People grow under my teaching","I study deeply to teach accurately","I love preparing lessons","Truth through me transforms lives",
        // 25. Tongues
        "I pray or sing in tongues regularly","Tongues is my personal prayer language","God gives me messages in tongues","Tongues strengthens my spirit","I desire tongues for edification",
        // 26. Wisdom (Word of)
        "God gives me supernatural solutions","I know what to do in crises","My counsel brings breakthrough","People seek me for godly wisdom","God’s wisdom flows through me",
        // 27. Witnessing / Testimony
        "My story opens doors for the gospel","People are drawn to Jesus through my testimony","I naturally share what God has done","My life witnesses even silently","Unbelievers listen when I speak",
        // 28. Writing
        "God speaks through my writing","My words in print impact lives","I clarify truth through writing","Writing is my main ministry tool","People grow through what I write"
    ];

    // Perfect shuffle: 5 rounds of all 28 gifts
    const shuffledIndices = [];
    for (let round = 0; round < 5; round++) {
        for (let g = 0; g < 28; g++) {
            shuffledIndices.push(g * 5 + round);
        }
    }
    const QUESTIONS = shuffledIndices.map(i => BASE_QUESTIONS[i]);

    // Biblical references for results page
    const GIFT_REFERENCES = {
        "Administration": "1 Cor 12:28; Rom 12:8",
        "Apostleship": "Eph 4:11; 1 Cor 12:28",
        "Craftsmanship": "Ex 31:1–6; 35:30–35",
        "Creative Communication": "Ps 45:1; Ex 35:30–35",
        "Discernment of Spirits": "1 Cor 12:10; 1 Jn 4:1",
        "Encouragement": "Rom 12:8; Acts 14:22",
        "Evangelism": "Eph 4:11; Acts 8:4",
        "Faith": "1 Cor 12:9",
        "Giving": "Rom 12:8; 2 Cor 8–9",
        "Healing": "1 Cor 12:9,28; Jas 5:14–15",
        "Helps/Service": "1 Cor 12:28; Rom 16:1–2",
        "Hospitality": "1 Pet 4:9–10; Rom 12:13",
        "Intercession": "Col 4:12; 1 Tim 2:1–2",
        "Interpretation of Tongues": "1 Cor 12:10; 14:27–28",
        "Knowledge": "1 Cor 12:8",
        "Leadership": "Rom 12:8; 1 Tim 3",
        "Mercy": "Rom 12:8; Lk 10:33–37",
        "Miracles": "1 Cor 12:10,28",
        "Music/Worship": "1 Chr 25; Ps 150",
        "Pastoral Care": "Eph 4:11; 1 Pet 5:1–4",
        "Prophecy": "Rom 12:6; 1 Cor 14:3",
        "Service": "Rom 12:7; Gal 5:13",
        "Shepherding": "Eph 4:11; Jn 10:1–18",
        "Teaching": "Rom 12:7; Eph 4:11",
        "Tongues": "1 Cor 12:10; 14:1–19",
        "Wisdom": "1 Cor 12:8; Jas 3:17",
        "Witnessing": "Acts 1:8; 1 Pet 3:15",
        "Writing": "Hab 2:2; Ps 45:1"
    };

    let currentAnswers = new Array(TOTAL_QUESTIONS + 1).fill(null);
    let currentQuestion = 1;
    let db = null, auth = null, userId = null, isFirebaseReady = false;

    const el = {
        questionNum: document.getElementById('current-question-num'),
        questionText: document.getElementById('question-text'),
        scoreInput: document.getElementById('score-input'),
        progressText: document.getElementById('progress-text'),
        progressBar: document.getElementById('progress-bar'),
        assessmentView: document.getElementById('assessment-view'),
        resultsView: document.getElementById('results-view'),
        topGiftDisplay: document.getElementById('top-gift-display'),
        topFourList: document.getElementById('top-four-list'),
        userIdDisplay: document.getElementById('user-id-display')
    };

    const appId = window.__app_id || 'local';
    let firebaseConfig = {};
    if (typeof window.__firebase_config === 'string' && window.__firebase_config.trim() !== '' && window.__firebase_config !== '{}') {
        try { firebaseConfig = JSON.parse(window.__firebase_config); } catch(e) {}
    }

    const updateUI = () => {
        const answered = currentAnswers.filter(a => a !== null).length;
        if (answered === TOTAL_QUESTIONS) { renderResults(); return; }
        while (currentQuestion <= TOTAL_QUESTIONS && currentAnswers[currentQuestion] !== null) currentQuestion++;
        el.questionNum.textContent = currentQuestion;
        el.questionText.innerHTML = QUESTIONS[currentQuestion - 1];
        el.scoreInput.value = '';
        el.scoreInput.placeholder = '?';
        el.scoreInput.focus();
        const pct = Math.round((answered / TOTAL_QUESTIONS) * 100);
        el.progressText.textContent = `${pct}% Complete`;
        el.progressBar.style.width = `${pct}%`;
    };

    document.getElementById('score-form').addEventListener('submit', e => {
        e.preventDefault();
        const score = parseInt(el.scoreInput.value);
        if (score >= 0 && score <= 5) {
            currentAnswers[currentQuestion] = score;
            saveProgress(currentAnswers);
            currentQuestion++;
            updateUI();
        }
    });

    const saveProgress = async (data) => {
        if (isFirebaseReady && userId) try {
            await setDoc(doc(db, "artifacts", appId, "users", userId, "assessment_progress", "data"), { answers: JSON.stringify(data) });
        } catch(e) {}
    };

    const loadProgress = async () => {
        if (!isFirebaseReady || !userId) return null;
        try {
            const snap = await getDoc(doc(db, "artifacts", appId, "users", userId, "assessment_progress", "data"));
            if (snap.exists() && snap.data().answers) return JSON.parse(snap.data().answers);
        } catch(e) {}
        return null;
    };

    const calculateResults = () => {
        const scores = GIFTS.map(() => 0);
        for (let i = 0; i < TOTAL_QUESTIONS; i++) {
            const answer = currentAnswers[i + 1];
            if (answer !== null) {
                const giftIndex = Math.floor(shuffledIndices[i] / 5);
                scores[giftIndex] += answer;
            }
        }
        return GIFTS.map((gift, i) => ({
            gift,
            score: scores[i],
            max: 25,
            ref: GIFT_REFERENCES[gift]
        })).sort((a, b) => b.score - a.score);
    };

    const renderResults = () => {
        const results = calculateResults();
        const top4 = results.slice(0, 4);

        el.assessmentView.classList.add('hidden');
        el.resultsView.classList.remove('hidden');

        const top = top4[0];
        el.topGiftDisplay.innerHTML = `
            <div class="text-center mb-10">
                <h2 class="text-6xl font-bold text-green-600 mb-4">${top.gift}</h2>
                <p class="text-3xl font-bold text-gray-800 mb-6">Your Strongest Gift</p>
                <p class="text-2xl text-gray-700 mb-6">Score: ${top.score} / 25</p>
                <p class="text-lg font-medium text-gray-600">Biblical Reference: ${top.ref}</p>
            </div>
        `;

        el.topFourList.innerHTML = results.slice(0, 7).map((g, i) => `
            <div class="bg-white rounded-2xl p-6 shadow-lg border-l-8 ${i===0 ? 'border-yellow-500' : 'border-indigo-300'}">
                <div class="flex justify-between items-center px-8 py-6">
                    <div class="text-5xl font-bold text-indigo-700">#${i+1}</div>
                    <div class="text-right">
                        <div class="text-2xl font-bold">${g.gift}</div>
                        <div class="text-lg text-gray-600">${g.score}/25 • ${g.ref}</div>
                    </div>
                </div>
            </div>
        `).join('');
    };

    window.app = { resetAssessment: () => location.reload() };

    const start = async () => {
        if (firebaseConfig.projectId) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
                onAuthStateChanged(auth, async user => {
                    if (user) {
                        userId = user.uid; isFirebaseReady = true;
                        el.userIdDisplay.textContent = "Connected • Cloud save active";
                        const saved = await loadProgress();
                        if (saved) currentAnswers = saved;
                        updateUI();
                    }
                });
                return;
            } catch (e) { console.log("Firebase failed, running offline"); }
        }
        el.userIdDisplay.textContent = "Offline mode • Local only";
        updateUI();
    };

    start();
</script>
</body>
</html>
