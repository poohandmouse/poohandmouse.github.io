<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spiritual Gifts Assessment</title>
   
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
   
    <!-- Config File (Firebase) - Optional -->
    <script src="./config.js"></script>
   
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const CATEGORIES = [
            "Apostleship", "Prophecy", "Evangelism", "Shepherding", "Teaching",
            "Serving", "Exhortation", "Giving", "Giving Aid", "Compassion",
            "Healing", "Working Miracles", "Tongues", "Interpretation of Tongues",
            "Wisdom", "Knowledge", "Faith", "Discernment", "Helps", "Administration"
        ];
        const QUESTION_COUNT = 200;

        const GIFT_DETAILS = {
            "Apostleship": {
                description: "You have a special ability to develop new ministries, churches, or missions in areas where the Gospel has not yet been established. You are a pioneer and an innovator.",
                prevalence: "1%",
                bibleCharacter: "Paul",
                bibleVerse: "2 Corinthians 11:28: 'Besides everything else, I face daily the pressure of my concern for all the churches.'",
                bibleVerse2: "Ephesians 4:11: 'So Christ himself gave the apostles, the prophets, the evangelists, the pastors and teachers.'"
            },
            "Prophecy": {
                description: "You are able to proclaim God's truth with clarity and apply it powerfully to a present situation, often speaking with great conviction and calling people to repentance and righteousness.",
                prevalence: "3%",
                bibleCharacter: "Agabus",
                bibleVerse: "Acts 11:28: 'One of them, named Agabus, stood up and through the Spirit predicted that a severe famine would spread over the entire Roman world.'",
                bibleVerse2: "1 Corinthians 14:3: 'But the one who prophesies speaks to people for their strengthening, encouraging and comfort.'"
            },
            "Evangelism": {
                description: "You have a deep desire and effectiveness in sharing the Gospel with non-believers, leading them to faith in Jesus Christ.",
                prevalence: "12%",
                bibleCharacter: "Philip",
                bibleVerse: "Acts 8:5-6: 'Philip went down to a city in Samaria and proclaimed the Messiah there. When the crowds heard Philip and saw the signs he performed, they all paid close attention to what he said.'",
                bibleVerse2: "Ephesians 4:11: 'So Christ himself gave the apostles, the prophets, the evangelists, the pastors and teachers.'"
            },
            "Shepherding": {
                description: "You have the capacity to care for the spiritual welfare of a group of believers, guiding, protecting, and nurturing them toward spiritual maturity. You are a true spiritual guide.",
                prevalence: "10%",
                bibleCharacter: "Peter",
                bibleVerse: "1 Peter 5:2: 'Be shepherds of God’s flock that is under your care, watching over them—not because you must, but because you are willing, as God wants you to be...'",
                bibleVerse2: "Ephesians 4:11: 'So Christ himself gave the apostles, the prophets, the evangelists, the pastors and teachers.'"
            },
            "Teaching": {
                description: "You are gifted at clearly explaining, systematizing, and applying God's Word in a way that helps others learn and grow in their faith.",
                prevalence: "15%",
                bibleCharacter: "Apollos",
                bibleVerse: "Acts 18:24-28: 'He vigorously refuted his Jewish opponents in public debate, proving from the Scriptures that Jesus was the Messiah.'",
                bibleVerse2: "Romans 12:7: 'If it is serving, then serve; if it is teaching, then teach;'"
            },
            "Serving": {
                description: "You find joy and fulfillment in meeting practical needs and alleviating burdens for others, often behind the scenes, with a spirit of humility.",
                prevalence: "25%",
                bibleCharacter: "Phoebe",
                bibleVerse: "Romans 16:1-2: '...she has been a great help to many people, including me.'",
                bibleVerse2: "1 Peter 4:11: 'If anyone serves, they should do so with the strength God provides...'"
            },
            "Exhortation": {
                description: "You have the ability to encourage, motivate, and counsel others toward action and greater spiritual vitality. You are an uplifter and motivator.",
                prevalence: "18%",
                bibleCharacter: "Barnabas",
                bibleVerse: "Acts 4:36: 'Joseph... whom the apostles called Barnabas (which means “son of encouragement”), sold a field he owned...'",
                bibleVerse2: "Romans 12:8: 'if it is to encourage, then give encouragement;'"
            },
            "Giving": {
                description: "You possess the ability to contribute material resources to the Lord's work with liberality and cheerfulness, often exceeding expected levels.",
                prevalence: "8%",
                bibleCharacter: "The Macedonian Churches",
                bibleVerse: "2 Corinthians 8:2-3: '...their overflowing joy and their extreme poverty welled up in rich generosity... even beyond their ability.'",
                bibleVerse2: "Romans 12:8: 'if it is to contribute to the needs of others, give generously;'"
            },
            "Giving Aid": {
                description: "Your gift is the capacity to wisely manage and steward resources, projects, or people to achieve God's goals. You bring order and efficiency.",
                prevalence: "10%",
                bibleCharacter: "Dorcas (Tabitha)",
                bibleVerse: "Acts 9:36: 'In Joppa there was a disciple named Tabitha... she was always doing good and helping the poor.'",
                bibleVerse2: "1 Corinthians 12:28: '...then miracles, then gifts of healing, of helping, of guidance...'"
            },
            "Compassion": {
                description: "You are able to feel genuine empathy and concern for suffering people and translate that compassion into effective action.",
                prevalence: "22%",
                bibleCharacter: "Jesus (The Good Samaritan)",
                bibleVerse: "Luke 10:33-34: 'But a Samaritan... took pity on him. He went to him and bandaged his wounds...'",
                bibleVerse2: "Romans 12:8: 'if it is to show mercy, do it cheerfully.'"
            },
            "Healing": {
                description: "You are used by God to restore health and wholeness, physically or emotionally, often instantaneously, demonstrating God's power.",
                prevalence: "2%",
                bibleCharacter: "Paul",
                bibleVerse: "Acts 14:8-10: 'Paul... called out, “Stand up on your feet!”'",
                bibleVerse2: "1 Corinthians 12:9: '...to another gifts of healing by that one Spirit,'"
            },
            "Working Miracles": {
                description: "You have the capacity to perform mighty acts of God that alter the normal course of nature, demonstrating the supernatural power of God.",
                prevalence: "1%",
                bibleCharacter: "Elijah",
                bibleVerse: "1 Kings 17:16: 'For the jar of flour was not used up and the jug of oil did not run dry...'",
                bibleVerse2: "1 Corinthians 12:10: '...to another miraculous powers...'"
            },
            "Tongues": {
                description: "You have the ability to speak a language you have never learned, either human or angelic, for prayer, self-edification, or corporate worship.",
                prevalence: "4%",
                bibleCharacter: "The Disciples at Pentecost",
                bibleVerse: "Acts 2:4: 'All of them were filled with the Holy Spirit and began to speak in other tongues as the Spirit enabled them.'",
                bibleVerse2: "1 Corinthians 14:4: 'Anyone who speaks in a tongue edifies themselves...'"
            },
            "Interpretation of Tongues": {
                description: "You are able to translate the message of one speaking in tongues so the entire body of Christ can be edified.",
                prevalence: "2%",
                bibleCharacter: "Paul (Instructing the Church)",
                bibleVerse: "1 Corinthians 14:13: 'For this reason the one who speaks in a tongue should pray that they may interpret what they say.'",
                bibleVerse2: "1 Corinthians 14:27: '...and someone must interpret.'"
            },
            "Wisdom": {
                description: "You are granted exceptional insight into how to apply spiritual truth to complex, specific situations and dilemmas.",
                prevalence: "6%",
                bibleCharacter: "Solomon",
                bibleVerse: "1 Kings 3:28: '...they saw that he had wisdom from God to administer justice.'",
                bibleVerse2: "1 Corinthians 12:8: '...a message of wisdom...'"
            },
            "Knowledge": {
                description: "You are given the capacity to discover, analyze, and systematize information and ideas that are critical to the growth of the church.",
                prevalence: "7%",
                bibleCharacter: "Luke",
                bibleVerse: "Luke 1:3-4: '...it seemed good also to me to write an orderly account... so that you may know the certainty...'",
                bibleVerse2: "1 Corinthians 12:8: '...a message of knowledge...'"
            },
            "Faith": {
                description: "You possess extraordinary confidence in God's power and promises, enabling you to step out and accomplish great things for Him against all apparent odds.",
                prevalence: "5%",
                bibleCharacter: "Abraham",
                bibleVerse: "Romans 4:20-21: '...was strengthened in his faith... being fully persuaded that God had power to do what he had promised.'",
                bibleVerse2: "1 Corinthians 12:9: '...to another faith by the same Spirit...'"
            },
            "Discernment": {
                description: "You have the power to clearly distinguish between truth and error, especially regarding the motives and spirits behind a person or situation.",
                prevalence: "11%",
                bibleCharacter: "Paul",
                bibleVerse: "Acts 16:18: 'Paul... said to the spirit, “In the name of Jesus Christ I command you to come out of her!”'",
                bibleVerse2: "1 Corinthians 12:10: '...to another distinguishing between spirits...'"
            },
            "Helps": {
                description: "Your gift is the ability to assist others in their ministry and tasks with efficiency and effectiveness, freeing them up to focus on their primary callings.",
                prevalence: "20%",
                bibleCharacter: "Timothy",
                bibleVerse: "Philippians 2:20-22: '...as a son with a father he has served with me in the work of the gospel.'",
                bibleVerse2: "Romans 16:2: '...give her any help she may need from you...'"
            },
            "Administration": {
                description: "You are skilled at planning, organizing, and directing groups of people to accomplish specific goals for the ministry or church.",
                prevalence: "13%",
                bibleCharacter: "Nehemiah",
                bibleVerse: "Nehemiah 2:17-18: 'Come, let us rebuild the wall of Jerusalem... They replied, “Let us start rebuilding.”'",
                bibleVerse2: "1 Corinthians 12:28: '...of guidance...' (administration)"
            }
        };

        // Global state
        let db, auth, userId = null, isFirebaseReady = false;
        let currentAnswers = new Array(QUESTION_COUNT + 1).fill(null);
        let currentQuestion = 1;

        // DOM elements
        const questionArea = document.getElementById('question-area');
        const scoreForm = document.getElementById('score-form');
        const scoreInput = document.getElementById('score-input');
        const progressText = document.getElementById('progress-text');
        const progressBar = document.getElementById('progress-bar');
        const assessmentView = document.getElementById('assessment-view');
        const resultsView = document.getElementById('results-view');
        const topGiftDisplay = document.getElementById('top-gift-display');
        const topFourList = document.getElementById('top-four-list');
        const statusMessage = document.getElementById('status-message');
        const userIdDisplay = document.getElementById('user-id-display');

        // Safe config loading
        const appId = window.__app_id || 'local-app';
        let firebaseConfig = {};
        try {
            const configStr = window.__firebase_config || '{}';
            firebaseConfig = JSON.parse(configStr);
        } catch (e) {
            firebaseConfig = {};
        }
        const initialAuthToken = window.__initial_auth_token || null;

        // Utility
        const showStatus = (msg, isError = false) => {
            statusMessage.textContent = msg;
            statusMessage.className = `text-center p-4 rounded-lg font-medium ${isError ? 'text-red-700 bg-red-100' : 'text-green-700 bg-green-100'}`;
            statusMessage.style.display = 'block';
            setTimeout(() => statusMessage.style.display = 'none', 4000);
        };

        const saveProgress = async (data) => {
            if (!isFirebaseReady) return;
            const ref = doc(db, "artifacts", appId, "users", userId, "assessment_progress", "data");
            try {
                await setDoc(ref, { answers: JSON.stringify(data), lastUpdated: new Date() });
            } catch (e) { /* silent fail - user already knows they're offline */ }
        };

        const loadProgress = async () => {
            if (!isFirebaseReady) return null;
            const ref = doc(db, "artifacts", appId, "users", userId, "assessment_progress", "data");
            const snap = await getDoc(ref);
            if (snap.exists() && snap.data().answers) {
                showStatus("Previous progress loaded from cloud!", false);
                return JSON.parse(snap.data().answers);
            }
            return null;
        };

        const updateUIAndFocus = () => {
            let answered = currentAnswers.filter(a => a !== null).length - 1;
            if (answered === QUESTION_COUNT) {
                renderResults();
                return;
            }

            while (currentQuestion <= QUESTION_COUNT && currentAnswers[currentQuestion] !== null) {
                currentQuestion++;
            }
            if (currentQuestion > QUESTION_COUNT) {
                renderResults();
                return;
            }

            questionArea.innerHTML = `<h3 class="text-3xl font-bold text-indigo-800">Question ${currentQuestion} / ${QUESTION_COUNT}</h3>
                                     <p class="text-lg mt-3 text-gray-600">Score 0 (Not at all) → 5 (Very Strongly)</p>`;

            scoreInput.value = currentAnswers[currentQuestion] || 0;
            scoreInput.focus();
            scoreInput.select();

            const pct = (answered / QUESTION_COUNT) * 100;
            progressText.textContent = `Progress: ${answered}/200 (${pct.toFixed(0)}%)`;
            progressBar.style.width = `${pct}%`;

            resultsView.classList.add('hidden');
            assessmentView.classList.remove('hidden');
        };

        scoreForm.addEventListener('submit', e => {
            e.preventDefault();
            const score = parseInt(scoreInput.value, 10);
            if (isNaN(score) || score < 0 || score > 5) {
                showStatus("Please enter a number 0–5", true);
                return;
            }
            currentAnswers[currentQuestion] = score;
            saveProgress(currentAnswers);
            currentQuestion++;
            updateUIAndFocus();
        });

        const calculateResults = () => {
            const sums = new Array(20).fill(0);
            for (let q = 1; q <= QUESTION_COUNT; q++) {
                if (currentAnswers[q] !== null) {
                    sums[(q - 1) % 20] += currentAnswers[q];
                }
            }
            return CATEGORIES.map((g, i) => ({ gift: g, score: sums[i] }))
                             .sort((a, b) => b.score - a.score);
        };

        const renderResults = () => {
            const sorted = calculateResults();
            const top = sorted[0];
            const d = GIFT_DETAILS[top.gift];

            assessmentView.classList.add('hidden');
            resultsView.classList.remove('hidden');

            topGiftDisplay.innerHTML = `
                <h4 class="text-xl font-semibold text-gray-700">Your Primary Gift</h4>
                <h1 class="text-6xl font-extrabold text-green-600 my-4">${top.gift}</h1>
                <p class="text-2xl font-bold mb-6">Score: ${top.score} / 100</p>

                <div class="bg-green-50 p-6 rounded-2xl border-2 border-green-300 mb-8">
                    <p class="text-lg leading-relaxed">${d.description}</p>
                    <p class="text-sm text-green-700 font-bold mt-4">Only ~${d.prevalence} of believers score highest in this gift.</p>
                </div>

                <div class="bg-blue-50 p-6 rounded-2xl border-2 border-blue-300">
                    <h3 class="text-2xl font-bold text-blue-800 mb-4">Biblical Example: ${d.bibleCharacter}</h3>
                    <div class="space-y-4 text-gray-700">
                        <p class="italic">"${d.bibleVerse}"</p>
                        <p class="italic text-sm">"${d.bibleVerse2}"</p>
                    </div>
                </div>
            `;

            topFourList.innerHTML = '';
            sorted.slice(0, 4).forEach((item, i) => {
                const dd = GIFT_DETAILS[item.gift];
                const rankStyle = i === 0 ? 'bg-yellow-100 border-yellow-400' : 'bg-gray-50 border-gray-300';
                topFourList.innerHTML += `
                    <div class="p-5 rounded-xl border-2 ${rankStyle} flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <span class="text-3xl font-bold text-indigo-600">#${i + 1}</span>
                            <div>
                                <div class="text-xl font-bold">${item.gift}</div>
                                <div class="text-sm text-gray-600">~${dd.prevalence} prevalence</div>
                            </div>
                        </div>
                        <span class="text-2xl font-bold text-green-600">${item.score}</span>
                    </div>
                `;
            });
        };

        window.app = {
            loadProgressAndStart: async () => {
                const saved = await loadProgress();
                if (saved && saved.length === QUESTION_COUNT + 1) {
                    currentAnswers = saved;
                    while (currentQuestion <= QUESTION_COUNT && currentAnswers[currentQuestion] !== null) currentQuestion++;
                } else {
                    currentAnswers = new Array(QUESTION_COUNT + 1).fill(null);
                    currentQuestion = 1;
                }
                updateUIAndFocus();
            },
            resetAssessment: () => {
                if (prompt("Type YES to permanently delete all progress:") === "YES") {
                    currentAnswers = new Array(QUESTION_COUNT + 1).fill(null);
                    currentQuestion = 1;
                    if (isFirebaseReady) saveProgress(currentAnswers);
                    showStatus("All progress cleared. Starting fresh!");
                    updateUIAndFocus();
                }
            }
        };

        // FIXED: No more scary red error when config.js is missing!
        const initializeFirebase = async () => {
            const hasValidConfig = firebaseConfig && firebaseConfig.projectId;

            if (!hasValidConfig) {
                // This is totally normal — just run locally
                userIdDisplay.textContent = "Running locally (offline mode)";
                window.app.loadProgressAndStart();
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, user => {
                    if (user) {
                        userId = user.uid;
                        isFirebaseReady = true;
                        userIdDisplay.textContent = `Connected • User: ${userId.slice(0, 8)}...`;
                        window.app.loadProgressAndStart();
                    }
                });

            } catch (err) {
                console.warn("Firebase failed to connect. Running offline.", err);
                userIdDisplay.textContent = "Offline mode (no cloud save)";
                window.app.loadProgressAndStart();
            }
        };

        window.onload = initializeFirebase;
    </script>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-green-50 min-h-screen p-4">
    <div class="max-w-4xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden mt-8">
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-8 text-center text
