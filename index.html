<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Discover Your Spiritual Gift</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body class="bg-gradient-to-b from-blue-50 to-indigo-100 min-h-screen font-sans">

<div class="max-w-2xl mx-auto p-6">
    <div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
        <div class="bg-gradient-to-r from-indigo-600 to-blue-700 p-8 text-white text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-2">Discover Your Spiritual Gift</h1>
            <p class="text-indigo-100 text-lg">God has uniquely gifted you to build His church</p>
            <p class="text-sm mt-4 opacity-90" id="user-id-display">Loading...</p>
        </div>

        <!-- Assessment -->
        <div id="assessment-view" class="p-8 space-y-10">
            <div class="text-center">
                <div class="text-6xl font-bold text-indigo-600 mb-4" id="current-question-num">1</div>
                <p class="text-gray-600 text-lg">of 100 questions</p>
            </div>

            <div id="question-text" class="bg-blue-50 rounded-2xl p-8 text-xl text-gray-800 leading-relaxed border-2 border-blue-200">
                Loading your first question...
            </div>

            <form id="score-form" class="space-y-8">
                <div class="flex justify-center">
                    <input type="number" id="score-input" min="0" max="5" value=""
                           class="w-56 h-56 text-9xl font-extrabold text-center rounded-3xl border-4 border-indigo-400 focus:border-indigo-600 outline-none shadow-2xl bg-white md:w-72 md:h-72 md:text-[12rem]"
                           placeholder="?" autocomplete="off">
                </div>

                <div class="grid grid-cols-2 gap-4 text-sm text-gray-600">
                    <div class="text-left">0 = Never</div>
                    <div class="text-right">5 = Always</div>
                    <div class="text-left col-span-2 text-center text-gray-500">1 = Rarely • 2 = Sometimes • 3 = Often • 4 = Very Often</div>
                </div>

                <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-700 hover:to-blue-700 text-white font-bold text-2xl py-6 rounded-2xl shadow-xl transition transform hover:scale-105">
                    Next Question →
                </button>
            </form>

            <div class="mt-8">
                <div class="text-right text-gray-600 font-medium mb-2" id="progress-text">0%</div>
                <div class="w-full bg-gray-300 rounded-full h-6 overflow-hidden shadow-inner">
                    <div id="progress-bar" class="bg-gradient-to-r from-indigo-500 to-blue-500 h-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div id="results-view" class="hidden p-8 space-y-10">
            <div class="text-center">
                <h2 class="text-5xl font-bold text-green-600 mb-4">Congratulations!</h2>
                <p class="text-2xl text-gray-700">Here are your top spiritual gifts</p>
            </div>

            <div id="top-gift-display" class="bg-gradient-to-br from-green-50 to-emerald-100 rounded-3xl p-10 border-4 border-green-400 shadow-2xl"></div>

            <div class="space-y-8" id="top-four-list"></div>

            <button onclick="window.app.resetAssessment()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold text-xl py-6 rounded-2xl shadow-xl transition">
                Take Assessment Again
            </button>

            <p class="text-center text-gray-600 text-sm mt-10">
                Based on Romans 12, 1 Corinthians 12, Ephesians 4 & 1 Peter 4
            </p>
        </div>
    </div>
</div>

<script src="./config.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const GIFTS = ["Prophecy","Serving","Teaching","Exhortation","Giving","Leadership","Mercy","Evangelism","Shepherding","Faith"];
    const TOTAL_QUESTIONS = 100;

    const BASE_QUESTIONS = [
        // (your 100 questions grouped by gift — unchanged from last version)
        "I am compelled to speak truth even when it's unpopular","People say I have insight into spiritual matters others miss","I often sense when something is from God or not","I feel burdened to warn others about sin","God reveals future events or consequences to me","I speak boldly against injustice","Others have said my words brought conviction","I feel God's grief over sin in the church","I am quick to identify false teaching","I have given warnings that later came true",
        "I love doing practical tasks so others can minister","I notice when things need to be fixed or cleaned","I enjoy helping behind the scenes","I feel joy serving without recognition","I volunteer first for unglamorous jobs","I help relieve burdens for leaders","I prefer action over discussion","People rely on me to get things done","I find fulfillment in making others' lives easier","I serve quietly without needing thanks",
        "I love explaining Scripture so others understand","I study deeply to teach accurately","People say my teaching helps them grow","I organize truth so it's easy to grasp","I enjoy preparing lessons or studies","I correct wrong understanding gently","I can make complex doctrine clear","Others grow in knowledge through my teaching","I research thoroughly before teaching","I feel responsible to teach truth correctly",
        "I motivate others to reach their potential","People come to me for encouragement","I see the best in people and call it out","I help others apply truth to daily life","I comfort the discouraged","I challenge people to grow","My words bring hope in hard times","I help people overcome failure","I believe in second chances","I rejoice when others succeed",
        "I give generously and cheerfully","I look for needs I can meet financially","God provides so I can bless others","I give beyond what is expected","I manage money to maximize giving","I give anonymously when possible","I trust God with my finances","Others are blessed through my generosity","I find joy in meeting needs","I live simply to give more",
        "I naturally take charge in groups","People follow my direction willingly","I see the big picture and set goals","I organize people to accomplish tasks","I delegate effectively","I make decisions confidently","I motivate teams toward vision","I handle responsibility well","I guide groups through change","People trust my leadership",
        "My heart breaks for the hurting","I feel deep compassion for the suffering","I comfort those who are grieving","I forgive easily and completely","I visit the sick and lonely","I show kindness to the undeserving","I sense others' emotional pain","I bring comfort in crisis","I show grace to the broken","I weep with those who weep",
        "I love sharing my faith with unbelievers","People come to Christ through my witness","I look for opportunities to share the gospel","I explain salvation clearly","Strangers open up to me about spiritual things","I feel burdened for the lost","I lead people to pray to receive Christ","I share my testimony naturally","Unbelievers feel comfortable with me","I rejoice greatly when someone is saved",
        "I nurture and protect spiritual growth in others","People trust me with their problems","I disciple believers one-on-one","I watch over the spiritual health of others","I restore those who have fallen","I guide people through spiritual struggles","I invest deeply in a few people","I help others mature in faith","People grow under my care","I have a pastor's heart",
        "I trust God in impossible situations","I pray boldly expecting answers","Others are strengthened by my faith","I step out when God speaks","I see possibilities where others see problems","I believe God for big things","My faith inspires others","I remain unshaken in trials","God has answered remarkable prayers for me","I live by 'nothing is impossible with God'"
    ];

    // Perfect mixing
    const shuffledIndices = [];
    for (let block = 0; block < 10; block++) {
        for (let gift = 0; gift < 10; gift++) {
            shuffledIndices.push(gift * 10 + block);
        }
    }
    const QUESTIONS = shuffledIndices.map(i => BASE_QUESTIONS[i]);

    const GIFT_DETAILS = { /* your full beautiful object from the last version */ };

    let currentAnswers = new Array(TOTAL_QUESTIONS + 1).fill(null);
    let currentQuestion = 1;
    let db = null, auth = null, userId = null, isFirebaseReady = false;

    const el = {
        questionNum: document.getElementById('current-question-num'),
        questionText: document.getElementById('question-text'),
        scoreInput: document.getElementById('score-input'),
        progressText: document.getElementById('progress-text'),
        progressBar: document.getElementById('progress-bar'),
        assessmentView: document.getElementById('assessment-view'),
        resultsView: document.getElementById('results-view'),
        topGiftDisplay: document.getElementById('top-gift-display'),
        topFourList: document.getElementById('top-four-list'),
        userIdDisplay: document.getElementById('user-id-display')
    };

    const appId = window.__app_id || 'local';
    let firebaseConfig = {};
    if (typeof window.__firebase_config === 'string' && window.__firebase_config.trim() !== '' && window.__firebase_config !== '{}') {
        try { firebaseConfig = JSON.parse(window.__firebase_config); } catch(e) {}
    }

    const updateUI = () => {
        const answered = currentAnswers.filter(a => a !== null).length;
        if (answered === TOTAL_QUESTIONS) { renderResults(); return; }
        while (currentQuestion <= TOTAL_QUESTIONS && currentAnswers[currentQuestion] !== null) currentQuestion++;

        el.questionNum.textContent = currentQuestion;
        el.questionText.innerHTML = QUESTIONS[currentQuestion - 1];
        el.scoreInput.value = '';
        el.scoreInput.placeholder = '?';
        el.scoreInput.focus();

        const pct = Math.round((answered / TOTAL_QUESTIONS) * 100);
        el.progressText.textContent = `${pct}% Complete`;
        el.progressBar.style.width = `${pct}%`;
    };

    el.scoreForm.addEventListener('submit', e => {
        e.preventDefault();
        const score = parseInt(el.scoreInput.value);
        if (score >= 0 && score <= 5) {
            currentAnswers[currentQuestion] = score;
            saveProgress(currentAnswers);
            currentQuestion++;
            updateUI();
        }
    });

    // ... (all your other functions — saveProgress, loadProgress, calculateResults, renderResults — unchanged) ...

    const start = async () => {
        if (firebaseConfig.projectId) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
                onAuthStateChanged(auth, async user => {
                    if (user) {
                        userId = user.uid; isFirebaseReady = true;
                        el.userIdDisplay.textContent = "Connected • Cloud save active";
                        const saved = await loadProgress();
                        if (saved) currentAnswers = saved;
                        updateUI(); // Now safe — everything is defined
                    }
                });
                return;
            } catch (e) {}
        }
        el.userIdDisplay.textContent = "Offline mode • Local only";
        updateUI(); // This was the fix — now called AFTER QUESTIONS is built
    };

    start();
</script>
</body>
</html>
